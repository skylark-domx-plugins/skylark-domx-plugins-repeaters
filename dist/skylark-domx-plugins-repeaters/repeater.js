/**
 * skylark-domx-plugins-repeaters - The skylark repeater plugin library
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-domx-plugins/skylark-domx-plugins-repeaters/
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-langx/langx","skylark-domx-browser","skylark-domx-eventer","skylark-domx-noder","skylark-domx-geom","skylark-domx-velm","skylark-domx-query","skylark-domx-fx","skylark-domx-plugins-base","skylark-domx-plugins-popups/select-list","skylark-domx-plugins-popups/combobox","./repeaters","./searchbox","./view-type-registry"],function(e,t,i,n,s,a,r,l,o,h,d,p,c,g,u){var f=h.Plugin.inherit({klassName:"Repeater",pluginName:"lark.repeaters.repeater",options:{dataSource:function(e,t){t({count:0,end:0,items:[],page:0,pages:1,start:0})},defaultView:-1,dropPagingCap:10,staticHeight:-1,views:null,searchOnKeyPress:!1,allowCancel:!0,addons:{views:["table","tile"]}},throb:function(e){return o.throb(this._elm,e)},_construct:function(e,i){this.overrided(e,i);var n,s,a=this,r=this.$();this.$canvas=r.find(".repeater-canvas"),this.$count=r.find(".repeater-count"),this.$end=r.find(".repeater-end"),this.$filters=r.find(".repeater-filters"),this.$loader=r.find(".repeater-loader"),this.$pageSize=r.find(".repeater-itemization .selectlist"),this.$nextBtn=r.find(".repeater-next"),this.$pages=r.find(".repeater-pages"),this.$prevBtn=r.find(".repeater-prev"),this.$primaryPaging=r.find(".repeater-primaryPaging"),this.$search=r.find(".repeater-search").find(".search"),this.$secondaryPaging=r.find(".repeater-secondaryPaging"),this.$start=r.find(".repeater-start"),this.$viewport=r.find(".repeater-viewport"),this.$views=r.find(".repeater-views"),r.on("mousedown.bs.dropdown.data-api",'[data-toggle="dropdown"]',function(e){l(this).plugin("lark.popups.dropdown")}),this.currentPage=0,this.currentView=null,this.isDisabled=!1,this.infiniteScrollingCallback=function(){},this.infiniteScrollingCont=null,this.infiniteScrollingEnabled=!1,this.infiniteScrollingEnd=null,this.infiniteScrollingOptions={},this.lastPageInput=0,this.pageIncrement=0,this.resizeTimeout={},this.stamp=(new Date).getTime()+(Math.floor(100*Math.random())+1),this.storedDataSourceOpts=null,this.syncingViewButtonState=!1,this.viewType=null,this.$filters.plugin("lark.popups.selectlist"),this.$pageSize.plugin("lark.popups.selectlist"),this.$primaryPaging.find(".combobox").plugin("lark.popups.combobox"),this.$search.plugin("lark.repeaters.searchbox",{searchOnKeyPress:this.options.searchOnKeyPress,allowCancel:this.options.allowCancel}),this.$filters.on("changed.lark.selectlist",function(e,t){a.$().trigger("filtered",t),a.render({clearInfinite:!0,pageIncrement:null})}),this.$nextBtn.on("click.lark.repeater",t.proxy(this.next,this)),this.$pageSize.on("changed.lark.selectlist",function(e,t){a.$().trigger("pageSizeChanged",t),a.render({pageIncrement:null})}),this.$prevBtn.on("click.lark.repeater",t.proxy(this.previous,this)),this.$primaryPaging.find(".combobox").on("changed.lark.combobox",function(e,t){a.pageInputChange(t.text,t)}),this.$search.on("searched.lark.search cleared.lark.search",function(e,t){a.$().trigger("searchChanged",t),a.render({clearInfinite:!0,pageIncrement:null})}),this.$search.on("canceled.lark.search",function(e,t){a.$().trigger("canceled",t),a.render({clearInfinite:!0,pageIncrement:null})}),this.$secondaryPaging.on("blur.lark.repeater",function(){a.pageInputChange(a.$secondaryPaging.val())}),this.$secondaryPaging.on("keyup",function(e){13===e.keyCode&&a.pageInputChange(a.$secondaryPaging.val())}),this.$views.find("input").on("change.lark.repeater",t.proxy(this.viewChanged,this)),l(window).on("resize.lark.repeater."+this.stamp,function(){clearTimeout(a.resizeTimeout),a.resizeTimeout=setTimeout(function(){a.resize(),a.$().trigger("resized")},75)}),-1!==this.options.defaultView?s=this.options.defaultView:(n=this.$views.find("label.active input"),s=n.length>0?n.val():"table"),this.initViewTypes(function(){a.resize(),a.$().trigger("resized"),a.render({changeView:s})})},clear:function(e){var t=e||{};t.preserve?this.infiniteScrollingEnabled&&!t.clearInfinite||v(this.$canvas):this.$canvas.empty();void 0!==t.viewChanged&&t.viewChanged;this._view&&this._view.cleared({options:t})},clearPreservedDataSourceOptions:function(){this.storedDataSourceOpts=null},destroy:function(){var e,i=this.$();return i.find("input").each(function(){l(this).attr("value",l(this).val())}),this.$canvas.empty(),e=this._elm.outerHTML,t.scall(i.find(".combobox").plugin("lark.popups.combobox"),"destroy"),t.scall(i.find(".selectlist").plugin("lark.popups.selectlist"),"destroy"),t.scall(i.find(".search").plugin("lark.repeaters.searchbox"),"destroy"),this.infiniteScrollingEnabled&&l(this.infiniteScrollingCont).infinitescroll("destroy"),i.remove(),l(window).off("resize.lark.repeater."+this.stamp),e},disable:function(){t.scall(this.$search.plugin("lark.repeaters.searchbox"),"disable"),t.scall(this.$filters.plugin("lark.popups.selectlist"),"disable"),this.$views.find("label, input").addClass("disabled").attr("disabled","disabled"),t.scall(this.$pageSize.plugin("lark.popups.selectlist"),"disable"),t.scall(this.$primaryPaging.find(".combobox").plugin("lark.popups.combobox"),"disable"),this.$secondaryPaging.attr("disabled","disabled"),this.$prevBtn.attr("disabled","disabled"),this.$nextBtn.attr("disabled","disabled"),this._view&&this._view.enabled({status:!1}),this.isDisabled=!0,this.$().addClass("disabled"),this.$().trigger("disabled")},enable:function(){t.scall(this.$search.plugin("lark.repeaters.searchbox"),"enable"),t.scall(this.$filters.plugin("lark.popups.selectlist"),"enable"),this.$views.find("label, input").removeClass("disabled").removeAttr("disabled"),t.scall(this.$pageSize.plugin("lark.popups.selectlist"),"enable"),t.scall(this.$primaryPaging.find(".combobox").plugin("lark.popups.combobox"),"enable"),this.$secondaryPaging.removeAttr("disabled"),this.$prevBtn.hasClass("page-end")||this.$prevBtn.removeAttr("disabled"),this.$nextBtn.hasClass("page-end")||this.$nextBtn.removeAttr("disabled"),this.$prevBtn.hasClass("page-end")&&this.$nextBtn.hasClass("page-end")&&t.scall(this.$primaryPaging.plugin("lark.popups.combobox"),"disable"),0!==parseInt(this.$count.html(),10)?t.scall(this.$pageSize.plugin("lark.popups.selectlist"),"enable"):t.scall(this.$pageSize.plugin("lark.popups.selectlist"),"disable"),this._view&&this._view.enabled({status:!0}),this.isDisabled=!1,this.$().removeClass("disabled"),this.$().trigger("enabled")},getDataOptions:function(e){var i=e||{};void 0!==i.pageIncrement&&(null===i.pageIncrement?this.currentPage=0:this.currentPage+=i.pageIncrement);var n={};i.dataSourceOptions&&(n=i.dataSourceOptions,i.preserveDataSourceOptions&&(this.storedDataSourceOpts?this.storedDataSourceOpts=t.mixin(this.storedDataSourceOpts,n):this.storedDataSourceOpts=n)),this.storedDataSourceOpts&&(n=t.mixin(this.storedDataSourceOpts,n));var s={view:this.currentView,pageIndex:this.currentPage,filter:{text:"All",value:"all"}};this.$filters.length>0&&(s.filter=this.$filters.plugin("lark.popups.selectlist").selectedItem()),this.infiniteScrollingEnabled||(s.pageSize=25,this.$pageSize.length>0&&(s.pageSize=parseInt(this.$pageSize.plugin("lark.popups.selectlist").selectedItem().value,10)));var a=this.$search&&this.$search.find("input")&&this.$search.find("input").val();return""!==a&&(s.search=a),this._view&&(s=this._view.dataOptions(s)),s=t.mixin(s,n)},infiniteScrolling:function(e,t){var i=this.$().find(".repeater-footer"),n=this.$().find(".repeater-viewport"),s=t||{};if(e)this.infiniteScrollingEnabled=!0,this.infiniteScrollingEnd=s.end,delete s.dataSource,delete s.end,this.infiniteScrollingOptions=s,n.css({height:n.height()+i.outerHeight()}),i.hide();else{var a=this.infiniteScrollingCont;delete a.data().infinitescroll,a.off("scroll"),a.removeClass("infinitescroll"),this.infiniteScrollingCont=null,this.infiniteScrollingEnabled=!1,this.infiniteScrollingEnd=null,this.infiniteScrollingOptions={},n.css({height:n.height()-i.outerHeight()}),i.show()}},infiniteScrollPaging:function(e){var t=!0!==this.infiniteScrollingEnd?this.infiniteScrollingEnd:void 0,i=e.page,n=e.pages;this.currentPage=void 0!==i?i:NaN,(!0===e.end||this.currentPage+1>=n)&&this.infiniteScrollingCont.infinitescroll("end",t)},initInfiniteScrolling:function(){var e=this.$canvas.find('[data-infinite="true"]:first');if((e=e.length<1?this.$canvas:e).data("lark.infinitescroll"))e.infinitescroll("enable");else{var i=this,n=t.mixin({},this.infiniteScrollingOptions);n.dataSource=function(e,t){i.infiniteScrollingCallback=t,i.render({pageIncrement:1})},e.infinitescroll(n),this.infiniteScrollingCont=e}},initViewTypes:function(e){this._views=[];var i=this.options.addons.views;if(t.isArray(i))for(var n=0;n<i.length;n++){if(!(r=u[i[n]]))throw new Error("The view type "+i[n]+" is not defined!");var s=r.ctor;this._views.push(this._views[i[n]]=new s(this))}else if(t.isPlainObject(i))for(var a in i){var r;if(!(r=u[a]))throw new Error("The view type "+i[n]+" is not defined!");s=r.ctor;this._views.push(this._views[a]=new s(this,i[a]))}e()},itemization:function(e){this.$count.html(void 0!==e.count?e.count:"?"),this.$end.html(void 0!==e.end?e.end:"?"),this.$start.html(void 0!==e.start?e.start:"?")},next:function(){this.$nextBtn.attr("disabled","disabled"),this.$prevBtn.attr("disabled","disabled"),this.pageIncrement=1,this.$().trigger("nextClicked"),this.render({pageIncrement:this.pageIncrement})},pageInputChange:function(e,t){var i;if(e!==this.lastPageInput){this.lastPageInput=e;var n=parseInt(e,10)-1;i=n-this.currentPage,this.$().trigger("pageChanged",[n,t]),this.render({pageIncrement:i})}},pagination:function(e){this.$primaryPaging.removeClass("active"),this.$secondaryPaging.removeClass("active");var t=e.pages;this.currentPage=void 0!==e.page?e.page:NaN;var i=0===t?0:this.currentPage+1;if(t<=this.options.dropPagingCap){this.$primaryPaging.addClass("active");var n=this.$primaryPaging.find(".dropdown-menu");n.empty();for(var s=0;s<t;s++){var a=s+1;n.append('<li data-value="'+a+'"><a href="#">'+a+"</a></li>")}this.$primaryPaging.find("input.form-control").val(i)}else this.$secondaryPaging.addClass("active"),this.$secondaryPaging.val(i);this.lastPageInput=this.currentPage+1+"",this.$pages.html(""+t),this.currentPage+1<t?(this.$nextBtn.removeAttr("disabled"),this.$nextBtn.removeClass("page-end")):(this.$nextBtn.attr("disabled","disabled"),this.$nextBtn.addClass("page-end")),this.currentPage-1>=0?(this.$prevBtn.removeAttr("disabled"),this.$prevBtn.removeClass("page-end")):(this.$prevBtn.attr("disabled","disabled"),this.$prevBtn.addClass("page-end")),0!==this.pageIncrement&&(this.pageIncrement>0?this.$nextBtn.is(":disabled")?this.$prevBtn.focus():this.$nextBtn.focus():this.$prevBtn.is(":disabled")?this.$nextBtn.focus():this.$prevBtn.focus())},previous:function(){this.$nextBtn.attr("disabled","disabled"),this.$prevBtn.attr("disabled","disabled"),this.pageIncrement=-1,this.$().trigger("previousClicked"),this.render({pageIncrement:this.pageIncrement})},render:function(e){this.disable();var t=!1,i=e||{};if(i.changeView&&this.currentView!==i.changeView){var n=this.currentView;this.currentView=i.changeView,this.viewType=this.currentView.split(".")[0],this._view=this._views[this.viewType],this.$().attr("data-currentview",this.currentView),this.$().attr("data-viewtype",this.viewType),t=!0,i.viewChanged=t,this.$().trigger("viewChanged",this.currentView),this.infiniteScrollingEnabled&&this.infiniteScrolling(!1),this._view.selected({prevView:n})}this.syncViewButtonState(),i.preserve=void 0!==i.preserve?i.preserve:!t,this.clear(i),(!this.infiniteScrollingEnabled||this.infiniteScrollingEnabled&&t)&&(this._throbber=this.throb({className:"throbWrap"}));var s=this.getDataOptions(i),a=this.options.dataSource,r=this,l=this._view;a(s,function(e){r.doRender({data:e,dataOptions:s,options:i,viewChanged:t,viewTypeObj:l})})},resize:function(){for(var e,t,i,n=-1===this.options.staticHeight?this.$().attr("data-staticheight"):this.options.staticHeight,s=[],a=[],r=this.$().parentsUntil(":visible"),o=0;o<r.length&&this.$().is(":hidden");)i=r[o],l(i).is(":hidden")&&(a.push(i.style.display),i.style.display="block",s.push(i)),o++;void 0!==n&&!1!==n&&"false"!==n?(this.$canvas.addClass("scrolling"),t={bottom:this.$viewport.css("margin-bottom"),top:this.$viewport.css("margin-top")},e=("true"===n||!0===n?this.$().height():parseInt(n,10))-this.$().find(".repeater-header").outerHeight()-this.$().find(".repeater-footer").outerHeight()-("auto"===t.bottom?0:parseInt(t.bottom,10))-("auto"===t.top?0:parseInt(t.top,10)),this.$viewport.outerHeight(e)):this.$canvas.removeClass("scrolling");this._view&&this._view.resize({height:this.$().outerHeight(),width:this.$().outerWidth()}),s.forEach(function(e,t){e.style.display=a[t]})},renderItems:function(e,t,i){e.render({container:this.$canvas,data:t},i),i(t)},viewChanged:function(e){var t=l(e.target),i=t.val();this.syncingViewButtonState||(this.isDisabled||t.parents("label:first").hasClass("disabled")?this.syncViewButtonState():this.render({changeView:i,pageIncrement:null}))},syncViewButtonState:function(){var e=this.$views.find('input[value="'+this.currentView+'"]');this.syncingViewButtonState=!0,this.$views.find("input").prop("checked",!1),this.$views.find("label.active").removeClass("active"),e.length>0&&(e.prop("checked",!0),e.parents("label:first").addClass("active")),this.syncingViewButtonState=!1},getNestedProperty:function(e,t){return t.replace(/\[(?:'([^']+)'|"([^"]+)"|(\d+))\]|(?:(?:^|\.)([^\.\[]+))/g,function(t,i,n,s,a){var r=a||i||n||s&&parseInt(s,10);t&&e&&(e=e[r])}),e},getDataProperty:function(e,t){var i,n;if(e.dataset?(i=t.replace(/-([a-z])/g,function(e,t){return t.toUpperCase()}),n=e.dataset[i]):e.getAttribute&&(n=e.getAttribute("data-"+t.replace(/([A-Z])/g,"-$1").toLowerCase())),"string"==typeof n){if(/^(true|false|null|-?\d+(\.\d+)?|\{[\s\S]*\}|\[[\s\S]*\])$/.test(n))try{return l.parseJSON(n)}catch(e){}return n}},getItemProperty:function(e,t){var i=this.getDataProperty(e,t);return void 0===i&&(i=e[t]),void 0===i&&(i=this.getNestedProperty(e,t)),i},doRender:function(e){var t=e.data||{};this.infiniteScrollingEnabled?this.infiniteScrollingCallback({}):(this.itemization(t),this.pagination(t));var i=this;this.renderItems(e.viewTypeObj,t,function(t){e.data=t,i.afterRender(e)})},callNextInit:function(e,t,i){var n=e+1;n<t.length?this.initViewType(n,t,i):i()},initViewType:function(e,t,i){var n=this;t[e].initialize?t[e].initialize.call(this,{},function(){n.callNextInit(e,t,i)}):n.callNextInit(e,t,i)},afterRender:function(e){var t=e.data||{};this.infiniteScrollingEnabled&&((e.viewChanged||e.options.clearInfinite)&&this.initInfiniteScrolling(),this.infiniteScrollPaging(t,e.options)),this._throbber&&(this._throbber.remove(),this._throbber=null),this.enable(),this.$search.trigger("rendered",{data:t,options:e.dataOptions,renderOptions:e.options}),this.$().trigger("rendered",{data:t,options:e.dataOptions,renderOptions:e.options}),this.$().trigger("loaded",e.dataOptions)}}),v=function e(t){var i=[];t.children().each(function(){var t=l(this),n=t.attr("data-preserve");"deep"===n?(t.detach(),i.push(t)):"shallow"===n&&(e(t),t.detach(),i.push(t))}),t.empty(),t.append(i)};return f.addons={},h.register(f),c.Repeater=f});
//# sourceMappingURL=sourcemaps/repeater.js.map

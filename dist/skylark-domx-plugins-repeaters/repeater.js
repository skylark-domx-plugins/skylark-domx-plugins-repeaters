/**
 * skylark-domx-plugins-repeaters - The skylark repeater plugin library
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-domx-plugins/skylark-domx-plugins-repeaters/
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-langx/langx","skylark-domx-browser","skylark-domx-eventer","skylark-domx-noder","skylark-domx-geom","skylark-domx-velm","skylark-domx-query","skylark-domx-fx","skylark-domx-plugins-base","skylark-domx-plugins-popups/select-list","skylark-domx-plugins-popups/combobox","skylark-domx-plugins-scrolls/infinite-scroll","./repeaters","./searchbox","./view-type-registry"],function(e,r,i,t,s,n,a,d,l,o,h,p,c,g,u,f){var v=o.Plugin.inherit({klassName:"Repeater",pluginName:"lark.repeaters.repeater",options:{dataSource:function(e,i){i({count:0,end:0,items:[],page:0,pages:1,start:0})},defaultView:-1,dropPagingCap:10,staticHeight:-1,views:null,searchOnKeyPress:!1,allowCancel:!0,addons:{views:["table","tile"]}},throb:function(e){return l.throb(this._elm,e)},_construct:function(e,i){this.overrided(e,i);var t,s=this,e=this.$();this.$canvas=e.find(".repeater-canvas"),this.$count=e.find(".repeater-count"),this.$end=e.find(".repeater-end"),this.$filters=e.find(".repeater-filters"),this.$loader=e.find(".repeater-loader"),this.$pageSize=e.find(".repeater-itemization .selectlist"),this.$nextBtn=e.find(".repeater-next"),this.$pages=e.find(".repeater-pages"),this.$prevBtn=e.find(".repeater-prev"),this.$primaryPaging=e.find(".repeater-primaryPaging"),this.$search=e.find(".repeater-search").find(".search"),this.$secondaryPaging=e.find(".repeater-secondaryPaging"),this.$start=e.find(".repeater-start"),this.$viewport=e.find(".repeater-viewport"),this.$views=e.find(".repeater-views"),e.on("mousedown.bs.dropdown.data-api",'[data-toggle="dropdown"]',function(e){d(this).plugin("lark.popups.dropdown")}),this.currentPage=0,this.currentView=null,this.isDisabled=!1,this.infiniteScrollingCallback=function(){},this.infiniteScrollingCont=null,this.infiniteScrollingEnabled=!1,this.infiniteScrollingEnd=null,this.infiniteScrollingOptions={},this.lastPageInput=0,this.pageIncrement=0,this.resizeTimeout={},this.stamp=(new Date).getTime()+(Math.floor(100*Math.random())+1),this.storedDataSourceOpts=null,this.syncingViewButtonState=!1,this.viewType=null,this.$filters.plugin("lark.popups.selectlist"),this.$pageSize.plugin("lark.popups.selectlist"),this.$primaryPaging.find(".combobox").plugin("lark.popups.combobox"),this.$search.plugin("lark.repeaters.searchbox",{searchOnKeyPress:this.options.searchOnKeyPress,allowCancel:this.options.allowCancel}),this.$filters.on("changed.lark.selectlist",function(e,i){s.$().trigger("filtered",i),s.render({clearInfinite:!0,pageIncrement:null})}),this.$nextBtn.on("click.lark.repeater",r.proxy(this.next,this)),this.$pageSize.on("changed.lark.selectlist",function(e,i){s.$().trigger("pageSizeChanged",i),s.render({pageIncrement:null})}),this.$prevBtn.on("click.lark.repeater",r.proxy(this.previous,this)),this.$primaryPaging.find(".combobox").on("changed.lark.combobox",function(e,i){s.pageInputChange(i.text,i)}),this.$search.on("searched.lark.search cleared.lark.search",function(e,i){s.$().trigger("searchChanged",i),s.render({clearInfinite:!0,pageIncrement:null})}),this.$search.on("canceled.lark.search",function(e,i){s.$().trigger("canceled",i),s.render({clearInfinite:!0,pageIncrement:null})}),this.$secondaryPaging.on("blur.lark.repeater",function(){s.pageInputChange(s.$secondaryPaging.val())}),this.$secondaryPaging.on("keyup",function(e){13===e.keyCode&&s.pageInputChange(s.$secondaryPaging.val())}),this.$views.find("input").on("change.lark.repeater",r.proxy(this.viewChanged,this)),d(window).on("resize.lark.repeater."+this.stamp,function(){clearTimeout(s.resizeTimeout),s.resizeTimeout=setTimeout(function(){s.resize(),s.$().trigger("resized")},75)}),t=-1!==this.options.defaultView?this.options.defaultView:0<(i=this.$views.find("label.active input")).length?i.val():"table",this.initViewTypes(function(){s.resize(),s.$().trigger("resized"),s.render({changeView:t})})},clear:function(e){e=e||{};e.preserve?this.infiniteScrollingEnabled&&!e.clearInfinite||$(this.$canvas):this.$canvas.empty(),void 0!==e.viewChanged&&e.viewChanged;this._view&&this._view.cleared({options:e})},clearPreservedDataSourceOptions:function(){this.storedDataSourceOpts=null},destroy:function(){var e,i=this.$();return i.find("input").each(function(){d(this).attr("value",d(this).val())}),this.$canvas.empty(),e=this._elm.outerHTML,r.scall(i.find(".combobox").plugin("lark.popups.combobox"),"destroy"),r.scall(i.find(".selectlist").plugin("lark.popups.selectlist"),"destroy"),r.scall(i.find(".search").plugin("lark.repeaters.searchbox"),"destroy"),this.infiniteScrollingEnabled&&d(this.infiniteScrollingCont).plugin("lark.scrolls.infinitescroll","destroy"),i.remove(),d(window).off("resize.lark.repeater."+this.stamp),e},disable:function(){r.scall(this.$search.plugin("lark.repeaters.searchbox"),"disable"),r.scall(this.$filters.plugin("lark.popups.selectlist"),"disable"),this.$views.find("label, input").addClass("disabled").attr("disabled","disabled"),r.scall(this.$pageSize.plugin("lark.popups.selectlist"),"disable"),r.scall(this.$primaryPaging.find(".combobox").plugin("lark.popups.combobox"),"disable"),this.$secondaryPaging.attr("disabled","disabled"),this.$prevBtn.attr("disabled","disabled"),this.$nextBtn.attr("disabled","disabled"),this._view&&this._view.enabled({status:!1}),this.isDisabled=!0,this.$().addClass("disabled"),this.$().trigger("disabled")},enable:function(){r.scall(this.$search.plugin("lark.repeaters.searchbox"),"enable"),r.scall(this.$filters.plugin("lark.popups.selectlist"),"enable"),this.$views.find("label, input").removeClass("disabled").removeAttr("disabled"),r.scall(this.$pageSize.plugin("lark.popups.selectlist"),"enable"),r.scall(this.$primaryPaging.find(".combobox").plugin("lark.popups.combobox"),"enable"),this.$secondaryPaging.removeAttr("disabled"),this.$prevBtn.hasClass("page-end")||this.$prevBtn.removeAttr("disabled"),this.$nextBtn.hasClass("page-end")||this.$nextBtn.removeAttr("disabled"),this.$prevBtn.hasClass("page-end")&&this.$nextBtn.hasClass("page-end")&&r.scall(this.$primaryPaging.plugin("lark.popups.combobox"),"disable"),0!==parseInt(this.$count.html(),10)?r.scall(this.$pageSize.plugin("lark.popups.selectlist"),"enable"):r.scall(this.$pageSize.plugin("lark.popups.selectlist"),"disable"),this._view&&this._view.enabled({status:!0}),this.isDisabled=!1,this.$().removeClass("disabled"),this.$().trigger("enabled")},getDataOptions:function(e){var e=e||{},i=(void 0!==e.pageIncrement&&(null===e.pageIncrement?this.currentPage=0:this.currentPage+=e.pageIncrement),{}),e=(e.dataSourceOptions&&(i=e.dataSourceOptions,e.preserveDataSourceOptions)&&(this.storedDataSourceOpts?this.storedDataSourceOpts=r.mixin(this.storedDataSourceOpts,i):this.storedDataSourceOpts=i),this.storedDataSourceOpts&&(i=r.mixin(this.storedDataSourceOpts,i)),{view:this.currentView,pageIndex:this.currentPage,filter:{text:"All",value:"all"}}),t=(0<this.$filters.length&&(e.filter=this.$filters.plugin("lark.popups.selectlist").selectedItem()),this.infiniteScrollingEnabled||(e.pageSize=25,0<this.$pageSize.length&&(e.pageSize=parseInt(this.$pageSize.plugin("lark.popups.selectlist").selectedItem().value,10))),this.$search&&this.$search.find("input")&&this.$search.find("input").val());return""!==t&&(e.search=t),this._view&&(e=this._view.dataOptions(e)),e=r.mixin(e,i)},infiniteScrolling:function(e,i){var t=this.$().find(".repeater-footer"),s=this.$().find(".repeater-viewport"),i=i||{};e?(this.infiniteScrollingEnabled=!0,this.infiniteScrollingEnd=i.end,delete i.dataSource,delete i.end,this.infiniteScrollingOptions=i,s.css({height:s.height()+t.outerHeight()}),t.hide()):(delete(e=this.infiniteScrollingCont).data().infinitescroll,e.off("scroll"),e.removeClass("infinitescroll"),this.infiniteScrollingCont=null,this.infiniteScrollingEnabled=!1,this.infiniteScrollingEnd=null,this.infiniteScrollingOptions={},s.css({height:s.height()-t.outerHeight()}),t.show())},infiniteScrollPaging:function(e){var i=!0!==this.infiniteScrollingEnd?this.infiniteScrollingEnd:void 0,t=e.page,s=e.pages;this.currentPage=void 0!==t?t:NaN,(!0===e.end||this.currentPage+1>=s)&&(t=this.infiniteScrollingCont.plugin("lark.scrolls.infinitescroll","instance"))&&t.end(i)},initInfiniteScrolling:function(){var t,e,i=this.$canvas.find('[data-infinite="true"]:first');(i=i.length<1?this.$canvas:i).data("lark.scrolls.infinitescroll")?i.plugin("lark.scrolls.infinitescroll","enable"):((e=r.mixin({},(t=this).infiniteScrollingOptions)).dataSource=function(e,i){t.infiniteScrollingCallback=i,t.render({pageIncrement:1})},i.plugin("lark.scrolls.infinitescroll",e),this.infiniteScrollingCont=i)},initViewTypes:function(e){this._views=[];var i=this.options.addons.views;if(r.isArray(i))for(var t,s=0;s<i.length;s++){if(!(t=f[i[s]]))throw new Error("The view type "+i[s]+" is not defined!");var n=t.ctor;this._views.push(this._views[i[s]]=new n(this))}else if(r.isPlainObject(i))for(var a in i){if(!(t=f[a]))throw new Error("The view type "+i[s]+" is not defined!");n=t.ctor;this._views.push(this._views[a]=new n(this,i[a]))}e()},itemization:function(e){this.$count.html(void 0!==e.count?e.count:"?"),this.$end.html(void 0!==e.end?e.end:"?"),this.$start.html(void 0!==e.start?e.start:"?")},next:function(){this.$nextBtn.attr("disabled","disabled"),this.$prevBtn.attr("disabled","disabled"),this.pageIncrement=1,this.$().trigger("nextClicked"),this.render({pageIncrement:this.pageIncrement})},pageInputChange:function(e,i){var t;e!==this.lastPageInput&&(this.lastPageInput=e,t=(e=parseInt(e,10)-1)-this.currentPage,this.$().trigger("pageChanged",[e,i]),this.render({pageIncrement:t}))},pagination:function(e){this.$primaryPaging.removeClass("active"),this.$secondaryPaging.removeClass("active");var i=e.pages,e=(this.currentPage=void 0!==e.page?e.page:NaN,0===i?0:this.currentPage+1);if(i<=this.options.dropPagingCap){this.$primaryPaging.addClass("active");var t=this.$primaryPaging.find(".dropdown-menu");t.empty();for(var s=0;s<i;s++){var n=s+1;t.append('<li data-value="'+n+'"><a href="#">'+n+"</a></li>")}this.$primaryPaging.find("input.form-control").val(e)}else this.$secondaryPaging.addClass("active"),this.$secondaryPaging.val(e);this.lastPageInput=this.currentPage+1+"",this.$pages.html(""+i),this.currentPage+1<i?(this.$nextBtn.removeAttr("disabled"),this.$nextBtn.removeClass("page-end")):(this.$nextBtn.attr("disabled","disabled"),this.$nextBtn.addClass("page-end")),0<=this.currentPage-1?(this.$prevBtn.removeAttr("disabled"),this.$prevBtn.removeClass("page-end")):(this.$prevBtn.attr("disabled","disabled"),this.$prevBtn.addClass("page-end")),0!==this.pageIncrement&&(0<this.pageIncrement?this.$nextBtn.is(":disabled")?this.$prevBtn:this.$nextBtn:this.$prevBtn.is(":disabled")?this.$nextBtn:this.$prevBtn).focus()},previous:function(){this.$nextBtn.attr("disabled","disabled"),this.$prevBtn.attr("disabled","disabled"),this.pageIncrement=-1,this.$().trigger("previousClicked"),this.render({pageIncrement:this.pageIncrement})},render:function(e){this.disable();var i=!1,t=e||{},s=(t.changeView&&this.currentView!==t.changeView&&(e=this.currentView,this.currentView=t.changeView,this.viewType=this.currentView.split(".")[0],this._view=this._views[this.viewType],this.$().attr("data-currentview",this.currentView),this.$().attr("data-viewtype",this.viewType),i=!0,t.viewChanged=i,this.$().trigger("viewChanged",this.currentView),this.infiniteScrollingEnabled&&this.infiniteScrolling(!1),this._view.selected({prevView:e})),this.syncViewButtonState(),t.preserve=void 0!==t.preserve?t.preserve:!i,this.clear(t),(!this.infiniteScrollingEnabled||this.infiniteScrollingEnabled&&i)&&(this._throbber=this.throb({className:"throbWrap"})),this.getDataOptions(t)),n=this,a=this._view;this.options.dataSource(s,function(e){n.doRender({data:e,dataOptions:s,options:t,viewChanged:i,viewTypeObj:a})})},resize:function(){for(var e,i,t,s,n,a=-1===this.options.staticHeight?this.$().attr("data-staticheight"):this.options.staticHeight,r=[],l=[],o=this.$().parentsUntil(":visible"),h=0;h<o.length&&this.$().is(":hidden");)e=o[h],d(e).is(":hidden")&&(l.push(e.style.display),e.style.display="block",r.push(e)),h++;void 0!==a&&!1!==a&&"false"!==a?(this.$canvas.addClass("scrolling"),n={bottom:this.$viewport.css("margin-bottom"),top:this.$viewport.css("margin-top")},a="true"===a||!0===a?this.$().height():parseInt(a,10),i=this.$().find(".repeater-header").outerHeight(),t=this.$().find(".repeater-footer").outerHeight(),s="auto"===n.bottom?0:parseInt(n.bottom,10),n="auto"===n.top?0:parseInt(n.top,10),this.$viewport.outerHeight(a-i-t-s-n)):this.$canvas.removeClass("scrolling"),this._view&&this._view.resize({height:this.$().outerHeight(),width:this.$().outerWidth()}),r.forEach(function(e,i){e.style.display=l[i]})},viewChanged:function(e){var e=d(e.target),i=e.val();this.syncingViewButtonState||(this.isDisabled||e.parents("label:first").hasClass("disabled")?this.syncViewButtonState():this.render({changeView:i,pageIncrement:null}))},syncViewButtonState:function(){var e=this.$views.find('input[value="'+this.currentView+'"]');this.syncingViewButtonState=!0,this.$views.find("input").prop("checked",!1),this.$views.find("label.active").removeClass("active"),0<e.length&&(e.prop("checked",!0),e.parents("label:first").addClass("active")),this.syncingViewButtonState=!1},getNestedProperty:function(a,e){return e.replace(/\[(?:'([^']+)'|"([^"]+)"|(\d+))\]|(?:(?:^|\.)([^\.\[]+))/g,function(e,i,t,s,n){n=n||i||t||s&&parseInt(s,10);e&&(a=a&&a[n])}),a},getDataProperty:function(e,i){var t;if(e.dataset?(t=i.replace(/-([a-z])/g,function(e,i){return i.toUpperCase()}),t=e.dataset[t]):e.getAttribute&&(t=e.getAttribute("data-"+i.replace(/([A-Z])/g,"-$1").toLowerCase())),"string"==typeof t){if(/^(true|false|null|-?\d+(\.\d+)?|\{[\s\S]*\}|\[[\s\S]*\])$/.test(t))try{return d.parseJSON(t)}catch(e){}return t}},getItemProperty:function(e,i){var t=this.getDataProperty(e,i);return t=void 0===(t=void 0===t?e[i]:t)?this.getNestedProperty(e,i):t},doRender:function(e){var i=e.data||{};this.infiniteScrollingEnabled?this.infiniteScrollingCallback({}):(this.itemization(i),this.pagination(i));e.viewTypeObj.render({container:this.$canvas,data:i}),this.afterRender(e)},callNextInit:function(e,i,t){e+=1;e<i.length?this.initViewType(e,i,t):t()},initViewType:function(e,i,t){var s=this;i[e].initialize?i[e].initialize.call(this,{},function(){s.callNextInit(e,i,t)}):s.callNextInit(e,i,t)},afterRender:function(e){var i=e.data||{};this.infiniteScrollingEnabled&&((e.viewChanged||e.options.clearInfinite)&&this.initInfiniteScrolling(),this.infiniteScrollPaging(i,e.options)),this._throbber&&(this._throbber.remove(),this._throbber=null),this.enable(),this.$search.trigger("rendered",{data:i,options:e.dataOptions,renderOptions:e.options}),this.$().trigger("rendered",{data:i,options:e.dataOptions,renderOptions:e.options}),this.$().trigger("loaded",e.dataOptions)}}),$=function t(e){var s=[];e.children().each(function(){var e=d(this),i=e.attr("data-preserve");"deep"===i?(e.detach(),s.push(e)):"shallow"===i&&(t(e),e.detach(),s.push(e))}),e.empty(),e.append(s)};return v.addons={},o.register(v),g.Repeater=v});
//# sourceMappingURL=sourcemaps/repeater.js.map
